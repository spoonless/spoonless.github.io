

<!DOCTYPE html>
<html class="writer-html5" lang="fr" >
<head>
  <meta charset="utf-8">
  <meta content="David Gayerie" name="author" />
<meta content="Développement d'application Android" name="description" />
<meta content="android, android studio, java, programmation objet" name="keywords" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Accès Web &mdash; Documentation Développement Android </title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom_rtd_theme.css" type="text/css" />

  
  
  
  
    <link rel="canonical" href="https://gayerie.dev/docs/java-android/android/acces_web.html"/>
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="Les services Android" href="service.html" />
    <link rel="prev" title="Gestion des messages broadcast" href="broadcast.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Développement Android
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Recherche dans les pages" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Développement d'applications pour Android</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="premiere_app.html">Une première application</a><ul>
<li class="toctree-l2"><a class="reference internal" href="premiere_app.html#creation-d-une-application-simple">Création d’une application simple</a></li>
<li class="toctree-l2"><a class="reference internal" href="premiere_app.html#organisation-du-projet">Organisation du projet</a></li>
<li class="toctree-l2"><a class="reference internal" href="premiere_app.html#lancement-de-l-application">Lancement de l’application</a><ul>
<li class="toctree-l3"><a class="reference internal" href="premiere_app.html#l-emulateur-android">L’émulateur Android</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="premiere_app.html#notion-d-activite">Notion d’activité</a></li>
<li class="toctree-l2"><a class="reference internal" href="premiere_app.html#notion-de-ressources">Notion de ressources</a><ul>
<li class="toctree-l3"><a class="reference internal" href="premiere_app.html#acceder-a-un-identifiant-de-ressource-depuis-le-code-java">Accéder à un identifiant de ressource depuis le code Java</a></li>
<li class="toctree-l3"><a class="reference internal" href="premiere_app.html#acceder-a-une-ressource-depuis-une-autre-ressource">Accéder à une ressource depuis une autre ressource</a></li>
<li class="toctree-l3"><a class="reference internal" href="premiere_app.html#identifier-une-ressource-dans-un-layout">Identifier une ressource dans un layout</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="premiere_app.html#exercices">Exercices</a></li>
<li class="toctree-l2"><a class="reference internal" href="premiere_app.html#le-fichier-androidmanifest-xml">Le fichier AndroidManifest.xml</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ui_layout.html">Conception d’interfaces graphiques</a><ul>
<li class="toctree-l2"><a class="reference internal" href="ui_layout.html#view-et-layout">View et Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="ui_layout.html#layout-xml">Layout XML</a></li>
<li class="toctree-l2"><a class="reference internal" href="ui_layout.html#layout-lineaire-et-positionnement">Layout linéaire et positionnement</a></li>
<li class="toctree-l2"><a class="reference internal" href="ui_layout.html#techniques-avancees-de-positionnement-dans-un-layout">Techniques avancées de positionnement dans un layout</a><ul>
<li class="toctree-l3"><a class="reference internal" href="ui_layout.html#layout-margin-et-padding">layout_margin et padding</a></li>
<li class="toctree-l3"><a class="reference internal" href="ui_layout.html#layout-gravity-et-gravity">layout_gravity et gravity</a></li>
<li class="toctree-l3"><a class="reference internal" href="ui_layout.html#layout-weight">layout_weight</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ui_layout.html#layout-par-contraintes">Layout par contraintes</a></li>
<li class="toctree-l2"><a class="reference internal" href="ui_layout.html#ajouter-une-image">Ajouter une image</a></li>
<li class="toctree-l2"><a class="reference internal" href="ui_layout.html#exemple-de-formulaire">Exemple de formulaire</a></li>
<li class="toctree-l2"><a class="reference internal" href="ui_layout.html#la-barre-d-action">La barre d’action</a><ul>
<li class="toctree-l3"><a class="reference internal" href="ui_layout.html#creer-un-menu-dans-la-barre-d-action">Créer un menu dans la barre d’action</a></li>
<li class="toctree-l3"><a class="reference internal" href="ui_layout.html#associer-un-menu-a-une-activite">Associer un menu à une activité</a></li>
<li class="toctree-l3"><a class="reference internal" href="ui_layout.html#implementer-les-actions-associees-aux-items-de-menu">Implémenter les actions associées aux items de menu</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ui_layout.html#les-boites-de-dialogue">Les boites de dialogue</a><ul>
<li class="toctree-l3"><a class="reference internal" href="ui_layout.html#boite-de-dialogue-avec-boutons">Boite de dialogue avec boutons</a></li>
<li class="toctree-l3"><a class="reference internal" href="ui_layout.html#boite-de-dialogue-avec-choix">Boite de dialogue avec choix</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ui_layout.html#message-a-l-utilisateur">Message à l’utilisateur</a><ul>
<li class="toctree-l3"><a class="reference internal" href="ui_layout.html#toast">Toast</a></li>
<li class="toctree-l3"><a class="reference internal" href="ui_layout.html#snackbar">Snackbar</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="activity.html">Les activités</a><ul>
<li class="toctree-l2"><a class="reference internal" href="activity.html#le-cycle-de-vie">Le cycle de vie</a><ul>
<li class="toctree-l3"><a class="reference internal" href="activity.html#terminer-une-activite">Terminer une activité</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="activity.html#gestion-de-l-etat-d-une-activite">Gestion de l’état d’une activité</a></li>
<li class="toctree-l2"><a class="reference internal" href="activity.html#notion-d-intent">Notion d’intent</a><ul>
<li class="toctree-l3"><a class="reference internal" href="activity.html#associer-une-activite-a-un-intent">Associer une activité à un intent</a></li>
<li class="toctree-l3"><a class="reference internal" href="activity.html#emettre-un-intent-implicite">Émettre un intent implicite</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="activity_stack.html">Gestion des activités d’une application</a><ul>
<li class="toctree-l2"><a class="reference internal" href="activity_stack.html#l-application-de-demo">L’application de démo</a></li>
<li class="toctree-l2"><a class="reference internal" href="activity_stack.html#structure-de-l-application">Structure de l’application</a><ul>
<li class="toctree-l3"><a class="reference internal" href="activity_stack.html#l-activite-principale-et-recyclerview">L’activité principale et RecyclerView</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="activity_stack.html#detail-d-une-occupation-et-pile-des-activites">Détail d’une occupation et pile des activités</a></li>
<li class="toctree-l2"><a class="reference internal" href="activity_stack.html#ouverture-d-une-activite-intent-explicite">Ouverture d’une activité (intent explicite)</a></li>
<li class="toctree-l2"><a class="reference internal" href="activity_stack.html#strategie-de-gestion-de-la-pile-des-activites">Stratégie de gestion de la pile des activités</a></li>
<li class="toctree-l2"><a class="reference internal" href="activity_stack.html#terminer-une-activite">Terminer une activité</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="broadcast.html">Gestion des messages broadcast</a><ul>
<li class="toctree-l2"><a class="reference internal" href="broadcast.html#le-broadcastreceiver">Le BroadcastReceiver</a><ul>
<li class="toctree-l3"><a class="reference internal" href="broadcast.html#suivre-le-branchement-sur-secteur">Suivre le branchement sur secteur</a></li>
<li class="toctree-l3"><a class="reference internal" href="broadcast.html#suivre-l-etat-de-la-connexion-wifi">Suivre l’état de la connexion Wifi</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="broadcast.html#recevoir-des-broadcasts-depuis-une-activite">Recevoir des broadcasts depuis une activité</a></li>
<li class="toctree-l2"><a class="reference internal" href="broadcast.html#emettre-un-message-broadcast">Émettre un message broadcast</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Accès Web</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#permission-pour-l-acces-internet">Permission pour l’accès Internet</a></li>
<li class="toctree-l2"><a class="reference internal" href="#utilisation-de-la-classe-url">Utilisation de la classe URL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#utilisation-de-la-bibliotheque-volley">Utilisation de la bibliothèque Volley</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#ajout-de-la-dependance">Ajout de la dépendance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#emission-d-une-requete">Émission d’une requête</a></li>
<li class="toctree-l3"><a class="reference internal" href="#emission-d-une-requete-pour-une-reponse-json">Émission d’une requête pour une réponse JSON</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="service.html">Les services Android</a><ul>
<li class="toctree-l2"><a class="reference internal" href="service.html#service-en-tache-de-fond">Service en tâche de fond</a><ul>
<li class="toctree-l3"><a class="reference internal" href="service.html#implementation-et-declaration-du-service">Implémentation et déclaration du service</a></li>
<li class="toctree-l3"><a class="reference internal" href="service.html#le-cycle-de-vie">Le cycle de vie</a></li>
<li class="toctree-l3"><a class="reference internal" href="service.html#execution-en-tache-de-fond">Exécution en tâche de fond</a></li>
<li class="toctree-l3"><a class="reference internal" href="service.html#interaction-avec-l-utilisateur">Interaction avec l’utilisateur</a></li>
<li class="toctree-l3"><a class="reference internal" href="service.html#lancement-du-service">Lancement du service</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="service.html#service-lie">Service lié</a><ul>
<li class="toctree-l3"><a class="reference internal" href="service.html#declaration-du-service">Déclaration du service</a></li>
<li class="toctree-l3"><a class="reference internal" href="service.html#id1">Le cycle de vie</a></li>
<li class="toctree-l3"><a class="reference internal" href="service.html#implementation-de-la-methode-onbind">Implémentation de la méthode onBind</a></li>
<li class="toctree-l3"><a class="reference internal" href="service.html#lier-le-service-a-une-activite">Lier le service à une activité</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Développement Android</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Accès Web</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
        <a href="service.html" class="btn btn-neutral float-right" title="Les services Android" accesskey="n">Suivant <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="broadcast.html" class="btn btn-neutral float-left" title="Gestion des messages broadcast" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Précédent</a>
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="acces-web">
<h1>Accès Web<a class="headerlink" href="#acces-web" title="Lien permanent vers ce titre">¶</a></h1>
<div class="exercice admonition">
<p class="admonition-title">Le projet d’exemple pour ce chapitre</p>
<p>Vous pouvez télécharger le projet contenant les exemples de ce chapitre :
<a class="reference download internal" download="" href="../_downloads/30e98d5ae390fe06de467ce9c37fb392/android-demo-app.zip"><code class="xref download docutils literal notranslate"><span class="pre">android-demo-app.zip</span></code></a></p>
</div>
<p>Il est courant pour une application mobile d’échanger des données par une
interface réseau. Les périphériques Android offrent de nombreuses interface :
Web avec le Wifi, USB, NFC, Bluetooth. Dans ce chapitre nous verrons comment
échanger des données sur le Web en interagissant avec des API Web.</p>
<div class="section" id="permission-pour-l-acces-internet">
<h2>Permission pour l’accès Internet<a class="headerlink" href="#permission-pour-l-acces-internet" title="Lien permanent vers ce titre">¶</a></h2>
<p>Certaines fonctionnalités ne sont accessibles que si l’application dispose
des droits suffisants. Pour accéder à Internet, une application doit obtenir
la permission pour le droit <code class="docutils literal notranslate"><span class="pre">android.permission.INTERNET</span></code>. Les permissions
requises sont listées dans le manifeste de l’application. Elles sont ensuite
présentées à l’utilisateur au moment de l’installation de l’application. Il doit
valider l’autorisation de ces permissions pour finaliser l’installation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Quand vous installez une application depuis Android Studio, vous n’avez pas
besoin de valider les permissions de votre application.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Déclaration de la permission dans le fichier AndroidManifest.xml</span><a class="headerlink" href="#id1" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;manifest</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
          <span class="na">package=</span><span class="s">&quot;dev.gayerie.monappli&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.INTERNET&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!--</span>
<span class="c">    ...</span>
<span class="c">  --&gt;</span>
<span class="nt">&lt;/manifest&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="utilisation-de-la-classe-url">
<h2>Utilisation de la classe URL<a class="headerlink" href="#utilisation-de-la-classe-url" title="Lien permanent vers ce titre">¶</a></h2>
<p>Pour accéder à une ressource sur le Web, vous pouvez utiliser les classes fournies
directement par l’API Java. Cependant, il est nécessaire de prendre en compte
les problématiques de développement asynchrone dans une application Android.</p>
<p>La classe <a class="reference external" href="https://developer.android.com/reference/java/net/URL">URL</a> en Java sert, bien évidemment, à représenter une URL. Mais elle
offre également une méthode <a class="reference external" href="https://developer.android.com/reference/java/net/URL#openConnection()">openConnection</a> qui permet d’initier une connexion à
l’adresse représentée. Cette méthode s’occupe de retourner un objet de type
<a class="reference external" href="https://developer.android.com/reference/java/net/URLConnection">URLConnection</a>. Il est possible de transtyper (<em>cast</em>) cet objet selon le schéma de
connexion utilisé. Par, exemple, l’API Android assure qu’elle peut prendre en
charge le schéma <code class="docutils literal notranslate"><span class="pre">http</span></code> avec la classe <a class="reference external" href="https://developer.android.com/reference/java/net/HttpURLConnection">HttpURLConnection</a> et le schéma <code class="docutils literal notranslate"><span class="pre">https</span></code>
avec la classe <a class="reference external" href="https://developer.android.com/reference/javax/net/ssl/HttpsURLConnection">HttpsURLConnection</a>. À partir de cette connexion, on peut obtenir
un flux d’entrée permettant de lire la réponse.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Exemple d’ouverture de connexion avec la classe URL</span><a class="headerlink" href="#id2" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="n">String</span> <span class="n">response</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="k">try</span> <span class="p">{</span>
  <span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="p">(</span><span class="s">&quot;http://monsite.fr/mapage&quot;</span><span class="p">);</span>
  <span class="n">URLConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="na">openConnection</span><span class="p">();</span>
  <span class="n">InputStream</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span>
  <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="p">(</span><span class="n">stream</span><span class="p">).</span><span class="na">useDelimiter</span><span class="p">(</span><span class="s">&quot;\0&quot;</span><span class="p">);</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">scanner</span><span class="p">.</span><span class="na">next</span><span class="p">();</span>
<span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">scanner</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">scanner</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Pour simplifier l’écriture, le code ci-dessus utilise un objet de type <a class="reference external" href="https://developer.android.com/reference/java/util/Scanner">Scanner</a>
pour lire le flux d’entrée. Même s’il est fonctionnel, ce code reste simpliste
et laisse de côté la gestion des erreurs, la gestion de l’encodage du message
reçu, le positionnement d’en-têtes pour la requête HTTP… Mais surtout, si
vous exécutez ce code dans une activité, vous obtiendrez une exception de type
<a class="reference external" href="https://developer.android.com/reference/android/os/">NetworkOnMainThreadException</a> car Android refuse de réaliser des accès réseaux
directement depuis le code d’une activité. Cela tient au fait qu’il est
difficile d’anticiper le temps nécessaire au traitement d’une requête HTTP :
elle peut être quasi-instantanée ou nécessiter plusieurs secondes, voire dizaines
de secondes. Or ce code est bloquant, puisqu’à la ligne 8, l’appel à la méthode
<a class="reference external" href="https://developer.android.com/reference/java/util/Scanner#next()">next</a> ne retourne que lorsque la totalité de la réponse aura été lue. Cela signifie
que l’activité serait figée et que l’utilisateur ne pourrait plus interagir avec
l’application pendant ce temps. Afin d’éviter ce comportement, Android nous
impose d’utiliser un appel asynchrone.</p>
<p>Les appels asynchrones permettent de réaliser des traitements pour lesquels nous
ne souhaitons pas que le programme attende le résultat. Cela permet à l’application
de ne pas se bloquer et de rester réactive aux demandes de l’utilisateur. Pour
une application Android, les traitements pouvant prendre plusieurs secondes
doivent être réalisés de manière asynchrone. Pour les appels réseaux, cela est
rendu obligatoire par l’implémentation de l’API Android.</p>
<p>Un appel asynchrone peut être réalisé en utilisant les classes fournies par l’API
Java telles que <a class="reference external" href="https://developer.android.com/reference/java/lang/Thread">Thread</a> ou l’interface <a class="reference external" href="https://developer.android.com/reference/java/util/concurrent/Executor">Executor</a> du package <a class="reference external" href="https://developer.android.com/reference/java/util/concurrent/package-summary">java.util.concurrent</a>.
Android fournit également la classe abstraite <a class="reference external" href="https://developer.android.com/reference/android/os/AsyncTask">AsyncTask</a> que nous allons utiliser
comme exemple.</p>
<p>La classe abstraite <a class="reference external" href="https://developer.android.com/reference/android/os/AsyncTask">AsyncTask</a> est une classe générique, qui dépend du type
de données en entrée, du type de données pour indiquer la progression de la tâche
et du type de données produites par la tâche. Pour notre exemple, en entrée nous
aurons des objets de type <a class="reference external" href="https://developer.android.com/reference/java/net/URL">URL</a> représentant les URL et en sortie une <a class="reference external" href="https://developer.android.com/reference/java/lang/String">String</a>
pour le contenu des pages. L’indicateur de progression est généralement un
<a class="reference external" href="https://developer.android.com/reference/java/lang/Integer">Integer</a> pour représenter un pourcentage de progression (pour garder notre exemple
simple, nous n’utiliserons pas le système de progression). Nous devons fournir
une implémentation de la méthode abstraite <a class="reference external" href="https://developer.android.com/reference/android/os/AsyncTask#doInBackground(Params...)">doInBackground</a> qui représente
le traitement de la tâche.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Exemple d’une AsyncTask pour le téléchargement de texte</span><a class="headerlink" href="#id3" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">dev.gayerie.monappli</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">android.os.AsyncTask</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.net.URLConnection</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DownloadTextTask</span> <span class="kd">extends</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">URL</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="p">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TAG</span> <span class="o">=</span> <span class="s">&quot;DownloadTextTask&quot;</span><span class="p">;</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="n">String</span> <span class="nf">doInBackground</span><span class="p">(</span><span class="n">URL</span><span class="p">...</span> <span class="n">urls</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">StringBuilder</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">();</span>
    <span class="k">for</span><span class="p">(</span><span class="n">URL</span> <span class="n">url</span><span class="p">:</span> <span class="n">urls</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="n">buffer</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">));</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&quot;Erreur lors de l&#39;accès à Internet&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">buffer</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">private</span> <span class="n">String</span> <span class="nf">download</span><span class="p">(</span><span class="n">URL</span> <span class="n">url</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
    <span class="n">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="n">URLConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="na">openConnection</span><span class="p">();</span>
      <span class="n">InputStream</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span>
      <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="p">(</span><span class="n">stream</span><span class="p">).</span><span class="na">useDelimiter</span><span class="p">(</span><span class="s">&quot;\0&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">scanner</span><span class="p">.</span><span class="na">next</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">scanner</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">scanner</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>La classe <code class="docutils literal notranslate"><span class="pre">DownloadTextTask</span></code> implémente la méthode privée <code class="docutils literal notranslate"><span class="pre">download</span></code> qui
reprend le code de téléchargement vu plus haut. Cette classe hérite de la méthode
<a class="reference external" href="https://developer.android.com/reference/android/os/AsyncTask#execute(Params...)">execute</a> qui permet de passer la tâche dans une file d’attente d’exécution.
Cette file d’attente est prise en charge par un autre <em>thread</em> qui appellera une
à une la méthode <a class="reference external" href="https://developer.android.com/reference/android/os/AsyncTask#doInBackground(Params...)">doInBackground</a> de toutes les tâches. Ce mécanisme permet de
garantir que le code de la tâche ne sera pas exécuté dans le même <em>thread</em> que
celui de l’activité.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">Appel de la tâche asynchrone depuis une activité</span><a class="headerlink" href="#id4" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">dev.gayerie.monappli</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.net.MalformedURLException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">InternetActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="p">{</span>

  <span class="kd">private</span> <span class="n">TextView</span> <span class="n">textView</span><span class="p">;</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">);</span>
    <span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">layout</span><span class="p">.</span><span class="na">activity_internet</span><span class="p">);</span>
    <span class="n">textView</span> <span class="o">=</span> <span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">infoView</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onResume</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">super</span><span class="p">.</span><span class="na">onResume</span><span class="p">();</span>
    <span class="n">DownloadTextTask</span> <span class="n">downloadTextTask</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DownloadTextTask</span><span class="p">()</span> <span class="p">{</span>
      <span class="nd">@Override</span>
      <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="p">(</span><span class="n">String</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ce code est appelé après le traitement asynchrone de doInBackground</span>
        <span class="n">textView</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>

    <span class="n">textView</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="s">&quot;Chargement en cours...&quot;</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="p">(</span><span class="s">&quot;https://tools.ietf.org/rfc/rfc7230.txt&quot;</span><span class="p">);</span>
      <span class="n">downloadTextTask</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">MalformedURLException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">textView</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="s">&quot;L&#39;URL n&#39;est pas bonne&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>L’activité <code class="docutils literal notranslate"><span class="pre">InternetActivity</span></code> récupère le document à l’adresse
<a class="reference external" href="https://tools.ietf.org/rfc/rfc7230.txt">https://tools.ietf.org/rfc/rfc7230.txt</a> pour l’afficher dans un composant <a class="reference external" href="https://developer.android.com/reference/android/widget/TextView">TextView</a>.
La méthode <code class="docutils literal notranslate"><span class="pre">onCreate</span></code> se limite à mettre en place le contenu de la vue à
partir d’un layout et de récupérer le composant <a class="reference external" href="https://developer.android.com/reference/android/widget/TextView">TextView</a> qui contiendra le
document téléchargé.</p>
<p>La méthode <code class="docutils literal notranslate"><span class="pre">onResume</span></code> réalise l’appel asynchrone. Elle définit une classe
anonyme qui hérite de <code class="docutils literal notranslate"><span class="pre">DownloadTextTask</span></code> en redéfinissant la méthode <a class="reference external" href="https://developer.android.com/reference/android/os/AsyncTask#onPostExecute(Result)">onPostExecute</a>
(lignes 23 à 29). La méthode <a class="reference external" href="https://developer.android.com/reference/android/os/AsyncTask#onPostExecute(Result)">onPostExecute</a> est fournie par
la classe <a class="reference external" href="https://developer.android.com/reference/android/os/AsyncTask">AsyncTask</a>. Elle ne réalise aucun traitement par défaut. Elle est appelée
dès que l’appel à la méthode <a class="reference external" href="https://developer.android.com/reference/android/os/AsyncTask#doInBackground(Params...)">doInBackground</a> est fini. <a class="reference external" href="https://developer.android.com/reference/android/os/AsyncTask">AsyncTask</a> nous garantit
que la méthode <a class="reference external" href="https://developer.android.com/reference/android/os/AsyncTask#onPostExecute(Result)">onPostExecute</a> est appelée dans le <em>thread</em> de l’activité et qu’elle
reçoit en paramètre l’objet qui a été retourné par l’appel à <a class="reference external" href="https://developer.android.com/reference/android/os/AsyncTask#doInBackground(Params...)">doInBackground</a>.
Nous pouvons donc récupérer le texte téléchargé et le positionner dans le
<a class="reference external" href="https://developer.android.com/reference/android/widget/TextView">TextView</a> (ligne 27). Les lignes 33 et 34 créent l’URL et la passe en paramètre
de la méthode <a class="reference external" href="https://developer.android.com/reference/android/os/AsyncTask#execute(Params...)">execute</a> (ligne 34) qui déclenche l’appel asynchrone.</p>
<p>On voit qu’une requête HTTP nécessite une attention particulière à cause de la
prise en charge du traitement asynchrone. Si l’exemple précédent a la vertu de
rendre apparents les mécanismes mis en œuvre pour réaliser ce traitement asynchrone,
le code produit est complexe à comprendre et source d’erreur lorsqu’une application
doit massivement faire des appels Web. Nous allons voir que nous pouvons
beaucoup simplifier notre code en ayant recours à une bibliothèque tierce qui
encapsulera une bonne partie de ces mécanismes pour nous.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>L’utilisation de <a class="reference external" href="https://developer.android.com/reference/android/os/AsyncTask">AsyncTask</a> est dépréciée pour les dernière versions de
l’API Android. En effet, le code présenté ci-dessus n’est pas exempt de
problèmes. À la ligne 27, on met à jour le <a class="reference external" href="https://developer.android.com/reference/android/widget/TextView">TextView</a> en résultat à l’appel
à la tâche distante. Mais qu’est-ce qui nous garantit que ce <a class="reference external" href="https://developer.android.com/reference/android/widget/TextView">TextView</a> est
encore disponible à ce moment-là ? Si la requête met plusieurs secondes
pour s’exécuter, l’utilisateur peut très bien décider de changer d’activité
ou même d’application. Il n’est donc pas sûr que le <a class="reference external" href="https://developer.android.com/reference/android/widget/TextView">TextView</a> soit toujours
visible et disponible. Cette implémentation peut produire des problèmes
de fuite de références (<em>references leak</em>).</p>
</div>
</div>
<div class="section" id="utilisation-de-la-bibliotheque-volley">
<span id="android-volley"></span><h2>Utilisation de la bibliothèque Volley<a class="headerlink" href="#utilisation-de-la-bibliotheque-volley" title="Lien permanent vers ce titre">¶</a></h2>
<p><a class="reference external" href="https://developer.android.com/training/volley">Volley</a> est une bibliothèque Android pour le traitement de requête HTTP. En plus
d’un support pour la création et l’analyse des réponses, elle fournit un support
complet intégrant le chiffrement pour les connexions https, la gestion d’un
cache client, la gestion concurrente dans l’émission de requêtes… <a class="reference external" href="https://developer.android.com/training/volley">Volley</a> est
également simple à mettre en place et à utiliser.</p>
<div class="section" id="ajout-de-la-dependance">
<h3>Ajout de la dépendance<a class="headerlink" href="#ajout-de-la-dependance" title="Lien permanent vers ce titre">¶</a></h3>
<p>Comme il s’agit d’une bibliothèque tierce, nous devons ajouter une dépendance
dans le fichier <code class="file docutils literal notranslate"><span class="pre">build.gradle</span></code> du module qui va utiliser <a class="reference external" href="https://developer.android.com/training/volley">Volley</a>.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">Ajout de la dépendance à Volley</span><a class="headerlink" href="#id5" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">dependencies</span> <span class="o">{</span>
  <span class="c1">// ...</span>

  <span class="n">implementation</span> <span class="s1">&#39;com.android.volley:volley:1.1.1&#39;</span>

  <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="emission-d-une-requete">
<h3>Émission d’une requête<a class="headerlink" href="#emission-d-une-requete" title="Lien permanent vers ce titre">¶</a></h3>
<p>Toutes les requêtes HTTP sont émises par Volley en tâche de fond de manière
asynchrone. Ces requêtes sont mises dans une file d’attente et sont traitées
au fur et à mesure par Volley. Dans notre code, nous devons commencer par
créer une file d’attente de type <a class="reference external" href="https://developer.android.com/training/volley/requestqueue">RequestQueue</a> pour pouvoir ensuite ajouter nos
requêtes.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">Création de la file d’attente</span><a class="headerlink" href="#id6" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">RequestQueue</span> <span class="n">requestQueue</span> <span class="o">=</span> <span class="n">Volley</span><span class="p">.</span><span class="na">newRequestQueue</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Une requête est représentée par la classe <code class="docutils literal notranslate"><span class="pre">Request&lt;T&gt;</span></code> ou une des classes qui
en héritent. Dans notre premier exemple, nous allons utiliser la classe
<code class="docutils literal notranslate"><span class="pre">StringRequest</span></code> qui attend un résultat sous la forme d’une chaîne de caractères.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">Envoi d’une requête</span><a class="headerlink" href="#id7" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;https://tools.ietf.org/rfc/rfc7230.txt&quot;</span><span class="p">;</span>
<span class="n">StringRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringRequest</span><span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="na">Method</span><span class="p">.</span><span class="na">GET</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span>
    <span class="k">new</span> <span class="n">Response</span><span class="p">.</span><span class="na">Listener</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResponse</span><span class="p">(</span><span class="n">String</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// traitement en cas de succès</span>
      <span class="p">}</span>
    <span class="p">},</span> <span class="k">new</span> <span class="n">Response</span><span class="p">.</span><span class="na">ErrorListener</span><span class="p">()</span> <span class="p">{</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onErrorResponse</span><span class="p">(</span><span class="n">VolleyError</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// traitement en cas d&#39;échec</span>
      <span class="p">}</span>
<span class="p">});</span>
<span class="n">requestQueue</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<p>De la ligne 2 à 13, nous créons la requête en passant quatre paramètres au
constructeur : la méthode HTTP à utiliser (dans cet exemple, GET), l’URL de
la requête, un objet <em>listener</em> pour le traitement du résultat de la requête en
cas de succès et un objet <em>listener</em> pour le traitement en cas d’échec.
<a class="reference external" href="https://developer.android.com/training/volley">Volley</a> masque pour nous l’envoi de la requête, le traitement asynchrone et la
transformation de la réponse. En cas de succès, la méthode du <em>listener</em> reçoit
en paramètre de la méthode <code class="docutils literal notranslate"><span class="pre">onResponse</span></code> le texte reçu. Pour envoyer cette
requête, il suffit de l’ajouter à la file d’attente (ligne 14).</p>
<p>Nous pouvons adapter ce code pour l’introduire dans une activité. Comme la
file d’attente est réutilisable, nous pouvons la créer au lancement de l’activité
et la conserver comme attribut.</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">Mise en place de Volley dans une activité</span><a class="headerlink" href="#id8" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">dev.gayerie.monappli</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.android.volley.Request</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.android.volley.RequestQueue</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.android.volley.Response</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.android.volley.VolleyError</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.android.volley.toolbox.StringRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.android.volley.toolbox.Volley</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">VolleyInternetActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="p">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">REQUEST_TAG</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="p">();</span>
  <span class="kd">private</span> <span class="n">RequestQueue</span> <span class="n">requestQueue</span><span class="p">;</span>
  <span class="kd">private</span> <span class="n">TextView</span> <span class="n">infoView</span><span class="p">;</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">);</span>
    <span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">layout</span><span class="p">.</span><span class="na">activity_volley_internet</span><span class="p">);</span>
    <span class="n">infoView</span> <span class="o">=</span> <span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">infoView</span><span class="p">);</span>
    <span class="n">requestQueue</span> <span class="o">=</span> <span class="n">Volley</span><span class="p">.</span><span class="na">newRequestQueue</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onResume</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">super</span><span class="p">.</span><span class="na">onResume</span><span class="p">();</span>
    <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;https://tools.ietf.org/rfc/rfc7230.txt&quot;</span><span class="p">;</span>
    <span class="n">StringRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringRequest</span><span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="na">Method</span><span class="p">.</span><span class="na">GET</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span>
        <span class="k">new</span> <span class="n">Response</span><span class="p">.</span><span class="na">Listener</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
          <span class="nd">@Override</span>
          <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResponse</span><span class="p">(</span><span class="n">String</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">infoView</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">},</span> <span class="k">new</span> <span class="n">Response</span><span class="p">.</span><span class="na">ErrorListener</span><span class="p">()</span> <span class="p">{</span>
          <span class="nd">@Override</span>
          <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onErrorResponse</span><span class="p">(</span><span class="n">VolleyError</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">infoView</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="s">&quot;Erreur de téléchargement : &quot;</span> <span class="o">+</span> <span class="n">error</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
          <span class="p">}</span>
    <span class="p">});</span>
    <span class="n">infoView</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="s">&quot;Chargement en cours...&quot;</span><span class="p">);</span>
    <span class="n">request</span><span class="p">.</span><span class="na">setTag</span><span class="p">(</span><span class="n">REQUEST_TAG</span><span class="p">);</span>
    <span class="n">requestQueue</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPause</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">super</span><span class="p">.</span><span class="na">onPause</span><span class="p">();</span>
    <span class="n">requestQueue</span><span class="p">.</span><span class="na">cancelAll</span><span class="p">(</span><span class="n">REQUEST_TAG</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>La file d’attente est créée ligne 26 au moment de la création de l’activité.
La requête HTTP est émise pour récupérer un texte qui doit être affiché dans un
<a class="reference external" href="https://developer.android.com/reference/android/widget/TextView">TextView</a> (lignes 32 à 47). À la ligne 46, nous ajoutons une étiquette à la
requête grâce à la méthode <code class="docutils literal notranslate"><span class="pre">setTag</span></code>. Cela permet de créer un groupe de requêtes
qu’il est possible d’annuler. Ligne 53, lorsque l’activité est mise en pause,
nous appelons la méthode <code class="docutils literal notranslate"><span class="pre">cancelAll</span></code> afin d’annuler une éventuelle requête en
attente qui n’aurait pas encore aboutie.</p>
</div>
<div class="section" id="emission-d-une-requete-pour-une-reponse-json">
<h3>Émission d’une requête pour une réponse JSON<a class="headerlink" href="#emission-d-une-requete-pour-une-reponse-json" title="Lien permanent vers ce titre">¶</a></h3>
<p>Une application Android est un client parfait pour une API Web. Les API Web
sont destinées à fournir sur le Web des informations traitables par des programmes.
La plupart du temps, ces informations sont échangées sous le format de
représentation JSON car il est facilement traitable par programmation.</p>
<p><a class="reference external" href="https://developer.android.com/training/volley">Volley</a> fournit deux spécialisations de la classe <code class="docutils literal notranslate"><span class="pre">Request&lt;T&gt;</span></code> : la classe
<code class="docutils literal notranslate"><span class="pre">JsonObjectRequest</span></code> qui attend en objet JSON en réponse et la classe
<code class="docutils literal notranslate"><span class="pre">JsonArrayRequest</span></code> qui attend un tableau JSON en réponse.</p>
<p>À titre d’exemple, nous allons utiliser l’API Géo mise en ligne par l’administration
publique pour fournir des informations sur les communes, les départements et les
régions en France.</p>
<p>Par exemple, si vous émettez la requête HTTP suivante :</p>
<blockquote>
<div><p><a class="reference external" href="https://geo.api.gouv.fr/departements/33?fields=nom,code,region">https://geo.api.gouv.fr/departements/33?fields=nom,code,region</a></p>
</div></blockquote>
<p>Vous obtiendrez le réponse suivante :</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Gironde&quot;</span><span class="p">,</span>
  <span class="nt">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;33&quot;</span><span class="p">,</span>
  <span class="nt">&quot;region&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;75&quot;</span><span class="p">,</span>
    <span class="nt">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Nouvelle-Aquitaine&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Pour en savoir plus sur cette API, vous pouvez vous référer à la
<a class="reference external" href="https://api.gouv.fr/documentation/api-geo">documentation officielle</a>.</p>
<p>La classe <code class="docutils literal notranslate"><span class="pre">JsonObjectRequest</span></code> offre un constructeur qui attend quatre
paramètres :</p>
<ol class="arabic simple">
<li><p>Une constante représentant la méthode HTTP à utiliser</p></li>
<li><p>L’URL de la ressource</p></li>
<li><p>Un objet de type <a class="reference external" href="https://developer.android.com/reference/org/json/JSONObject">JSONObject</a> représentant les données à envoyer dans la requête
(ou <code class="docutils literal notranslate"><span class="pre">null</span></code> si on ne souhaite pas envoyer de données)</p></li>
<li><p>Un <em>listener</em> de type <code class="docutils literal notranslate"><span class="pre">Listener&lt;JSONObject&gt;</span></code> pour traiter une réponse en succès</p></li>
<li><p>Un <em>listener</em> de type <code class="docutils literal notranslate"><span class="pre">ErrorListener</span></code> pour traiter une réponse en échec</p></li>
</ol>
<p>La classe <a class="reference external" href="https://developer.android.com/reference/org/json/JSONObject">JSONObject</a> est fournie par l’API Android est permet de construire ou
de consulter un document JSON en Java.</p>
<p>Nous pouvons déclarer une activité en utilisant le <em>layout</em> suivant :</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">Le layout de l’activité de consultation d’un département</span><a class="headerlink" href="#id9" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;androidx.appcompat.widget.LinearLayoutCompat</span>
  <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
  <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
  <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
  <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
  <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
  <span class="na">tools:context=</span><span class="s">&quot;.RegionActivity&quot;</span><span class="nt">&gt;</span>


  <span class="nt">&lt;EditText</span>
    <span class="na">android:id=</span><span class="s">&quot;@+id/codeDepartement&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
    <span class="na">android:ems=</span><span class="s">&quot;10&quot;</span>
    <span class="na">android:inputType=</span><span class="s">&quot;number&quot;</span>
    <span class="na">android:maxLength=</span><span class="s">&quot;2&quot;</span>
    <span class="na">android:hint=</span><span class="s">&quot;Code département&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;Button</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
    <span class="na">android:text=</span><span class="s">&quot;Rechercher&quot;</span>
    <span class="na">android:onClick=</span><span class="s">&quot;search&quot;</span><span class="nt">/&gt;</span>

  <span class="nt">&lt;TextView</span>
    <span class="na">android:id=</span><span class="s">&quot;@+id/departementResultat&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/androidx.appcompat.widget.LinearLayoutCompat&gt;</span>
</pre></div>
</div>
</div>
<p>Ce layout très simple déclare un champ de saisi texte pour le code du département,
un bouton pour lancer la recherche et un <a class="reference external" href="https://developer.android.com/reference/android/widget/TextView">TextView</a> pour afficher le résultat de
la recherche. Le bouton répond à l’événement <code class="docutils literal notranslate"><span class="pre">click</span></code> en invoquant la méthode
<code class="docutils literal notranslate"><span class="pre">search</span></code> de l’activité.</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">L’activité de consultation d’un département</span><a class="headerlink" href="#id10" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">dev.gayerie.monappli</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">android.widget.EditText</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.android.volley.Request</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.android.volley.RequestQueue</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.android.volley.Response</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.android.volley.VolleyError</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.android.volley.toolbox.JsonObjectRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.android.volley.toolbox.Volley</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.json.JSONException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.json.JSONObject</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RegionActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="p">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">REQUEST_TAG</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="p">();</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">URL_PATTERN</span> <span class="o">=</span> <span class="s">&quot;https://geo.api.gouv.fr/departements/%s?fields=nom,code,region&quot;</span><span class="p">;</span>
  <span class="kd">private</span> <span class="n">RequestQueue</span> <span class="n">requestQueue</span><span class="p">;</span>
  <span class="kd">private</span> <span class="n">EditText</span> <span class="n">codeDepartementEdit</span><span class="p">;</span>
  <span class="kd">private</span> <span class="n">TextView</span> <span class="n">departementResultatView</span><span class="p">;</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">);</span>
    <span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">layout</span><span class="p">.</span><span class="na">activity_region</span><span class="p">);</span>
    <span class="n">codeDepartementEdit</span> <span class="o">=</span> <span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">codeDepartement</span><span class="p">);</span>
    <span class="n">departementResultatView</span> <span class="o">=</span> <span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">departementResultat</span><span class="p">);</span>
    <span class="n">requestQueue</span> <span class="o">=</span> <span class="n">Volley</span><span class="p">.</span><span class="na">newRequestQueue</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onStop</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">super</span><span class="p">.</span><span class="na">onStop</span><span class="p">();</span>
    <span class="n">cancelRequest</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">cancelRequest</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">requestQueue</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">requestQueue</span><span class="p">.</span><span class="na">cancelAll</span><span class="p">(</span><span class="n">REQUEST_TAG</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">search</span><span class="p">(</span><span class="n">View</span> <span class="n">view</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">codeDepartement</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">codeDepartementEdit</span><span class="p">.</span><span class="na">getText</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">codeDepartement</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">codeDepartement</span><span class="p">.</span><span class="na">length</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">codeDepartement</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span> <span class="o">+</span> <span class="n">codeDepartement</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">sendRequest</span><span class="p">(</span><span class="n">codeDepartement</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendRequest</span><span class="p">(</span><span class="n">String</span> <span class="n">codeDepartement</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cancelRequest</span><span class="p">();</span>
    <span class="n">departementResultatView</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="s">&quot;Chargement...&quot;</span><span class="p">);</span>
    <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="n">URL_PATTERN</span><span class="p">,</span> <span class="n">codeDepartement</span><span class="p">);</span>
    <span class="n">JsonObjectRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JsonObjectRequest</span><span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="na">Method</span><span class="p">.</span><span class="na">GET</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
        <span class="k">new</span> <span class="n">Response</span><span class="p">.</span><span class="na">Listener</span><span class="o">&lt;</span><span class="n">JSONObject</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
          <span class="nd">@Override</span>
          <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResponse</span><span class="p">(</span><span class="n">JSONObject</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fillDepartementResultat</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">},</span> <span class="k">new</span> <span class="n">Response</span><span class="p">.</span><span class="na">ErrorListener</span><span class="p">()</span> <span class="p">{</span>
          <span class="nd">@Override</span>
          <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onErrorResponse</span><span class="p">(</span><span class="n">VolleyError</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="na">networkResponse</span> <span class="o">!=</span> <span class="kc">null</span>
               <span class="o">&amp;&amp;</span> <span class="n">error</span><span class="p">.</span><span class="na">networkResponse</span><span class="p">.</span><span class="na">statusCode</span> <span class="o">==</span> <span class="mi">404</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">departementResultatView</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="s">&quot;Pas de département trouvé. Veuillez vérifier le code saisi.&quot;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="n">departementResultatView</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="s">&quot;Erreur : &quot;</span> <span class="o">+</span> <span class="n">error</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
            <span class="p">}</span>
          <span class="p">}</span>
    <span class="p">});</span>
    <span class="n">request</span><span class="p">.</span><span class="na">setTag</span><span class="p">(</span><span class="n">REQUEST_TAG</span><span class="p">);</span>
    <span class="n">requestQueue</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">fillDepartementResultat</span><span class="p">(</span><span class="n">JSONObject</span> <span class="n">jsonObject</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="n">String</span> <span class="n">nomDepartement</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;nom&quot;</span><span class="p">);</span>
      <span class="n">String</span> <span class="n">codeDepartement</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;code&quot;</span><span class="p">);</span>
      <span class="n">JSONObject</span> <span class="n">jsonRegion</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">.</span><span class="na">getJSONObject</span><span class="p">(</span><span class="s">&quot;region&quot;</span><span class="p">);</span>
      <span class="n">String</span> <span class="n">nomRegion</span> <span class="o">=</span> <span class="n">jsonRegion</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;nom&quot;</span><span class="p">);</span>
      <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;%s est le département avec le code %s. Ce département fait partie de la région %s.&quot;</span><span class="p">,</span> <span class="n">nomDepartement</span><span class="p">,</span> <span class="n">codeDepartement</span><span class="p">,</span> <span class="n">nomRegion</span><span class="p">);</span>
      <span class="n">departementResultatView</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">JSONException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">departementResultatView</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="s">&quot;Erreur : &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>La méthode <code class="docutils literal notranslate"><span class="pre">onCreate</span></code> (lignes 24 à 31) récupère une référence sur les principaux
composants du <em>layout</em> et crée une <code class="docutils literal notranslate"><span class="pre">RequestQueue</span></code> pour <a class="reference external" href="https://developer.android.com/training/volley">Volley</a>. La méthode
<code class="docutils literal notranslate"><span class="pre">search</span></code> (lignes 45 à 54) qui est appelée lorsque l’utilisateur clique sur le
bouton, récupère l’information saisie et appelle la méthode privée <code class="docutils literal notranslate"><span class="pre">sendRequest</span></code>.
La méthode <code class="docutils literal notranslate"><span class="pre">sendRequest</span></code> (lignes 56 à 79) réalise la création de la requête
de type <code class="docutils literal notranslate"><span class="pre">JsonObjectRequest</span></code> et l’ajoute dans la file d’attente de <a class="reference external" href="https://developer.android.com/training/volley">Volley</a>.
Si la requête est un succès, le <em>listener</em> appelle la méthode <code class="docutils literal notranslate"><span class="pre">fillDepartementResultat</span></code>
(ligne 64). Enfin la méthode <code class="docutils literal notranslate"><span class="pre">fillDepartementResultat</span></code> (lignes 81 à 92)
extrait les informations de l’objet JSON pour construire le message à afficher
dans la <a class="reference external" href="https://developer.android.com/reference/android/widget/TextView">TextView</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pour envoyer des données au serveur dans la requête, il suffit de passer
un objet de type <a class="reference external" href="https://developer.android.com/reference/org/json/JSONObject">JSONObject</a> comme troisième paramètre à la construction
d’une instance de <code class="docutils literal notranslate"><span class="pre">JsonObjectRequest</span></code>. Imaginons que l’on dispose d’une API
Web permettant d’inscrire un nouvel utilisateur en envoyant son prénom et
son nom dans une requête POST. Le document JSON transmis serait de la forme :</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;prenom&quot;</span><span class="p">:</span> <span class="s2">&quot;David&quot;</span><span class="p">,</span>
  <span class="nt">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Gayerie&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Nous pouvons déclarer une méthode pour gérer cette requête avec <a class="reference external" href="https://developer.android.com/training/volley">Volley</a> :</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">Envoi de données au format JSON avec Volley</span><a class="headerlink" href="#id11" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">inscrire</span><span class="p">(</span><span class="n">String</span> <span class="n">prenom</span><span class="p">,</span> <span class="n">String</span> <span class="n">nom</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">JSONException</span> <span class="p">{</span>
  <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;https://inscription.formation.com/api&quot;</span><span class="p">;</span>
  <span class="n">JSONObject</span> <span class="n">requestPayload</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="p">();</span>
  <span class="n">requestPayload</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;prenom&quot;</span><span class="p">,</span> <span class="n">prenom</span><span class="p">);</span>
  <span class="n">requestPayload</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;nom&quot;</span><span class="p">,</span> <span class="n">nom</span><span class="p">);</span>

  <span class="n">JsonObjectRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JsonObjectRequest</span><span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="na">Method</span><span class="p">.</span><span class="na">POST</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">requestPayload</span><span class="p">,</span>
      <span class="k">new</span> <span class="n">Response</span><span class="p">.</span><span class="na">Listener</span><span class="o">&lt;</span><span class="n">JSONObject</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResponse</span><span class="p">(</span><span class="n">JSONObject</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// code en cas de succès</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="k">new</span> <span class="n">Response</span><span class="p">.</span><span class="na">ErrorListener</span><span class="p">()</span> <span class="p">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onErrorResponse</span><span class="p">(</span><span class="n">VolleyError</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// code en cas d&#39;échec</span>
        <span class="p">}</span>
  <span class="p">});</span>
  <span class="k">this</span><span class="p">.</span><span class="na">requestQueue</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="service.html" class="btn btn-neutral float-right" title="Les services Android" accesskey="n" rel="next">Suivant <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="broadcast.html" class="btn btn-neutral float-left" title="Gestion des messages broadcast" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Précédent</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright David Gayerie - david@gayerie.dev - CC-BY-SA

    </p>
  </div>


</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-99071053-2', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>