

<!DOCTYPE html>
<html class="writer-html5" lang="fr" >
<head>
  <meta charset="utf-8">
  <meta content="David Gayerie" name="author" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  

  <title>Programmation asynchrone avec async et await &mdash; JavaScript avancé</title>



  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom_rtd_theme.css" type="text/css" />

  
  
  
  
    <link rel="canonical" href="https://gayerie.dev/docs/js/javascript/async_await.html"/>
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="Introduction et mise en place" href="../threejs/introduction.html" />
    <link rel="prev" title="Les promesses" href="promesse.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> JavaScript avancé
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Recherche dans les pages" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">JavaScript (notions avancées)</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="evolution_syntaxe.html">Les évolutions de la syntaxe depuis ES5</a><ul>
<li class="toctree-l2"><a class="reference internal" href="evolution_syntaxe.html#le-mode-strict-es5">Le mode strict (ES5)</a></li>
<li class="toctree-l2"><a class="reference internal" href="evolution_syntaxe.html#declarer-une-variable-avec-let-et-const-es6">Déclarer une variable avec let et const (ES6)</a></li>
<li class="toctree-l2"><a class="reference internal" href="evolution_syntaxe.html#la-structure-for-of-es6">La structure for … of (ES6)</a></li>
<li class="toctree-l2"><a class="reference internal" href="evolution_syntaxe.html#gabarit-de-chaine-de-caracteres-es6">Gabarit de chaîne de caractères (ES6)</a></li>
<li class="toctree-l2"><a class="reference internal" href="evolution_syntaxe.html#valeur-par-defaut-des-parametres-es6">Valeur par défaut des paramètres (ES6)</a></li>
<li class="toctree-l2"><a class="reference internal" href="evolution_syntaxe.html#le-parametre-de-reste-es6">Le paramètre de reste (ES6)</a></li>
<li class="toctree-l2"><a class="reference internal" href="evolution_syntaxe.html#la-decomposition-de-tableau-es6">La décomposition de tableau (ES6)</a></li>
<li class="toctree-l2"><a class="reference internal" href="evolution_syntaxe.html#l-affectation-de-tableau-par-decomposition-es6">L’affectation de tableau par décomposition (ES6)</a></li>
<li class="toctree-l2"><a class="reference internal" href="evolution_syntaxe.html#l-affectation-d-objet-par-decomposition-es6">L’affectation d’objet par décomposition (ES6)</a></li>
<li class="toctree-l2"><a class="reference internal" href="evolution_syntaxe.html#l-operateur-d-exponentiation-es7">L’opérateur d’exponentiation (ES7)</a></li>
<li class="toctree-l2"><a class="reference internal" href="evolution_syntaxe.html#programmation-asynchrone-avec-async-et-await-es7">Programmation asynchrone avec async et await (ES7)</a></li>
<li class="toctree-l2"><a class="reference internal" href="evolution_syntaxe.html#operateur-de-coalescence-des-valeurs-nulles-es11">Opérateur de coalescence des valeurs nulles (ES11)</a></li>
<li class="toctree-l2"><a class="reference internal" href="evolution_syntaxe.html#chainage-optionnel-es11">Chaînage optionnel (ES11)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="modele_objet.html">Le modèle objet</a><ul>
<li class="toctree-l2"><a class="reference internal" href="modele_objet.html#creer-des-objets">Créer des objets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="modele_objet.html#la-declaration-litterale">La déclaration littérale</a></li>
<li class="toctree-l3"><a class="reference internal" href="modele_objet.html#le-constructeur">Le constructeur</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="modele_objet.html#le-prototype">Le prototype</a></li>
<li class="toctree-l2"><a class="reference internal" href="modele_objet.html#la-notion-de-propriete">La notion de propriété</a></li>
<li class="toctree-l2"><a class="reference internal" href="modele_objet.html#l-heritage">L’héritage</a></li>
<li class="toctree-l2"><a class="reference internal" href="modele_objet.html#la-notion-de-classe-depuis-es6">La notion de classe depuis ES6</a></li>
<li class="toctree-l2"><a class="reference internal" href="modele_objet.html#l-heritage-avec-les-classes">L’héritage avec les classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="modele_objet.html#utilisation-du-mot-cle-super">Utilisation du mot-clé super</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="fonctionnel.html">Programmation fonctionnelle</a><ul>
<li class="toctree-l2"><a class="reference internal" href="fonctionnel.html#les-arrow-functions">Les arrow functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="fonctionnel.html#l-utilisation-de-foreach">L’utilisation de forEach</a></li>
<li class="toctree-l2"><a class="reference internal" href="fonctionnel.html#le-modele-filter-map-reduce">Le modèle filter/map/reduce</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="module.html">Les modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="module.html#exporter">Exporter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="module.html#export-par-defaut">Export par défaut</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="module.html#importer">Importer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="symbol.html">Les symboles</a><ul>
<li class="toctree-l2"><a class="reference internal" href="symbol.html#les-symboles-comme-noms-de-proprietes">Les symboles comme noms de propriétés</a></li>
<li class="toctree-l2"><a class="reference internal" href="symbol.html#well-known-symbols">well-known symbols</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="iterateur_generateur.html">Les itérateurs et les générateurs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="iterateur_generateur.html#les-iterateurs">Les itérateurs</a></li>
<li class="toctree-l2"><a class="reference internal" href="iterateur_generateur.html#les-iterables">Les itérables</a></li>
<li class="toctree-l2"><a class="reference internal" href="iterateur_generateur.html#la-structure-for-of">La structure for … of</a></li>
<li class="toctree-l2"><a class="reference internal" href="iterateur_generateur.html#les-generateurs">Les générateurs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="promesse.html">Les promesses</a><ul>
<li class="toctree-l2"><a class="reference internal" href="promesse.html#la-classe-promise">La classe Promise</a></li>
<li class="toctree-l2"><a class="reference internal" href="promesse.html#le-chainage-des-appels">Le chaînage des appels</a></li>
<li class="toctree-l2"><a class="reference internal" href="promesse.html#traitements-paralleles">Traitements parallèles</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Programmation asynchrone avec async et await</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#fonction-asynchrone">Fonction asynchrone</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ordre-des-appels-dans-un-traitement-asynchrone">Ordre des appels dans un traitement asynchrone</a></li>
<li class="toctree-l2"><a class="reference internal" href="#la-boucle-for-await">La boucle for await</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">three.js</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../threejs/introduction.html">Introduction et mise en place</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../threejs/introduction.html#chargement-asynchrone-en-local">Chargement asynchrone en local</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threejs/introduction.html#fichier-html-de-base">Fichier HTML de base</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threejs/introduction.html#creation-d-un-renderer">Création d’un renderer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threejs/introduction.html#creation-d-une-camera">Création d’une caméra</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threejs/introduction.html#creation-d-une-scene">Création d’une scène</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threejs/introduction.html#rendu-d-une-scene">Rendu d’une scène</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threejs/introduction.html#redimensionnement-du-canevas">Redimensionnement du canevas</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../threejs/objets_et_scene.html">Objets et scène</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../threejs/objets_et_scene.html#repere-de-coordonnees">Repère de coordonnées</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threejs/objets_et_scene.html#mesh-et-geometry">Mesh et Geometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threejs/objets_et_scene.html#les-transformations-dans-l-espace">Les transformations dans l’espace</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../threejs/objets_et_scene.html#exercice">Exercice</a></li>
<li class="toctree-l3"><a class="reference internal" href="../threejs/objets_et_scene.html#une-animation-simple">Une animation simple</a></li>
<li class="toctree-l3"><a class="reference internal" href="../threejs/objets_et_scene.html#hierarchie-d-objets">Hiérarchie d’objets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../threejs/objets_et_scene.html#excercice">Excercice</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../threejs/materiaux.html">Les matériaux</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../threejs/materiaux.html#le-meshbasicmaterial">Le MeshBasicMaterial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threejs/materiaux.html#les-lumieres">Les lumières</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threejs/materiaux.html#les-materiaux-reagissant-a-la-lumiere">Les matériaux réagissant à la lumière</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../threejs/materiaux.html#excercice">Excercice</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../threejs/materiaux.html#textures-et-maps">Textures et Maps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../threejs/materiaux.html#chargement-d-une-texture">Chargement d’une texture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../threejs/materiaux.html#un-texture-comme-color-map">Un texture comme <em>color map</em></a></li>
<li class="toctree-l3"><a class="reference internal" href="../threejs/materiaux.html#les-autres-types-de-textures">Les autres types de textures</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../threejs/materiaux.html#les-ombres">Les ombres</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../threejs/interactions.html">Les interactions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../threejs/interactions.html#les-controleurs">Les contrôleurs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../threejs/interactions.html#le-controleur-orbital">Le contrôleur orbital</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../threejs/interactions.html#le-lancer-de-rayon">Le lancer de rayon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threejs/interactions.html#la-projection">La projection</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../threejs/chargement_scene.html">Chargement de modèle</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../threejs/chargement_scene.html#le-chargeur-gltf">Le chargeur glTF</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../threejs/animation_curve.html">Animation à partir de courbes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../threejs/animation_curve.html#les-courbes">Les courbes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threejs/animation_curve.html#representation-graphique-d-une-courbe">Représentation graphique d’une courbe</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threejs/animation_curve.html#animation-le-long-d-une-courbe">Animation le long d’une courbe</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threejs/animation_curve.html#exercice">Exercice</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">JavaScript avancé</a>
        
      </nav>


      <div class="wy-nav-content">
<div class="banner">D'autres formations sont sur <a href="https://gayerie.dev">https://gayerie.dev</a></div>

        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Programmation asynchrone avec async et await</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
        <a href="../threejs/introduction.html" class="btn btn-neutral float-right" title="Introduction et mise en place" accesskey="n">Suivant <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="promesse.html" class="btn btn-neutral float-left" title="Les promesses" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Précédent</a>
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="programmation-asynchrone-avec-async-et-await">
<span id="javascript-async-await"></span><h1>Programmation asynchrone avec async et await<a class="headerlink" href="#programmation-asynchrone-avec-async-et-await" title="Lien permanent vers ce titre">¶</a></h1>
<p>Si l’introduction des promesses a permis de formaliser le développement de code
asynchrone, elle n’a pas permis de résoudre un problème inhérent à l’utilisation
des fonctions <em>callback</em> : la difficulté de lecture et donc de maintenance d’un
tel code.</p>
<p>Nous pouvons nous inspirer de l’exemple vu au chapitre précédent d’une promesse
pour un appel ajax et créer une fonction pour réaliser des appels asynchrones
vers un serveur pour récupérer un document JSON :</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">getJson</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mf">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">responseText</span><span class="p">));</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">reject</span><span class="p">(</span><span class="s2">&quot;Erreur du serveur : &quot;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">status</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="nx">reject</span><span class="p">(</span><span class="s2">&quot;La requête ajax a échoué&quot;</span><span class="p">);</span>
    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Nous pouvons appeler cette fonction :</p>
<div class="highlight-javascript notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nx">getJson</span><span class="p">(</span><span class="s2">&quot;https://monserveur/data.json&quot;</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">json</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;nom&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">nom</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;prenom&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">prenom</span><span class="p">;</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">msg</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">;</span>
  <span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>Le code ci-dessus est très simple… et pourtant pas si facile à lire que ça.
Il faut garder à l’esprit que toutes ces <em>arrow functions</em> passées comme <em>callback</em>
ne seront pas forcément appelées. Il serait plus intéressant de pouvoir écrire
le même code séquentiellement car il devient plus facile à comprendre.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="k">try</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">getJson</span><span class="p">(</span><span class="s2">&quot;https://monserveur/data.json&quot;</span><span class="p">);</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;nom&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">nom</span><span class="p">;</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;prenom&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">prenom</span><span class="p">;</span>
<span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>C’est exactement pour cela que les mots-clés <code class="docutils literal notranslate"><span class="pre">async</span></code> et <code class="docutils literal notranslate"><span class="pre">await</span></code> ont été
introduits.</p>
<div class="section" id="fonction-asynchrone">
<h2>Fonction asynchrone<a class="headerlink" href="#fonction-asynchrone" title="Lien permanent vers ce titre">¶</a></h2>
<p>Une fonction peut être déclarée asynchrone grâce au mot clé <code class="docutils literal notranslate"><span class="pre">async</span></code>. Une fonction
asynchrone est une fonction qui appelle une fonction qui retourne une promesse
ou une autre fonction asynchrone. Une fonction asynchrone peut appeler une fonction
qui retourne une promesse ou une fonction asynchrone en spécifiant le mot-clé
<code class="docutils literal notranslate"><span class="pre">await</span></code>. Si nous reprenons l’exemple de la fonction <code class="docutils literal notranslate"><span class="pre">getJson</span></code>, elle retourne
une promesse. Elle peut donc être appelée dans une fonction asynchrone à l’aide
du mot-clé <code class="docutils literal notranslate"><span class="pre">await</span></code> :</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">maFonctionAsynchrone</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">getJson</span><span class="p">(</span><span class="s2">&quot;https://monserveur/data.json&quot;</span><span class="p">);</span>

  <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Le mot-clé <code class="docutils literal notranslate"><span class="pre">await</span></code> fonctionne de la manière suivante : il récupère la promesse
retournée par la fonction appelée et suspend l’exécution de la fonction asynchrone.
Lorsque la promesse est résolue, c’est-à-dire lorsque la fonction <code class="docutils literal notranslate"><span class="pre">resolve</span></code> est
appelée par la promesse, alors l’objet passé en paramètre est retourné par
<code class="docutils literal notranslate"><span class="pre">await</span></code> et le traitement de la fonction continue au point où il avait été suspendu.
Si la promesse échoue, c’est-à-dire si c’est la fonction <code class="docutils literal notranslate"><span class="pre">reject</span></code> qui est appelée
par la promesse, alors la valeur passée en paramètre est jetée comme une exception.</p>
<p>Ainsi, grâce aux mots-clés <code class="docutils literal notranslate"><span class="pre">async</span></code> et <code class="docutils literal notranslate"><span class="pre">await</span></code>, nous pouvons écrire
séquentiellement des traitements qui sont en fait asynchrones. Attention, le mot-clé
<code class="docutils literal notranslate"><span class="pre">await</span></code> ne peut être utilisé que dans le corps d’une fonction asynchrone.
Nous allons donc définir une fonction pour réécrire notre traitement :</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="nx">async</span> <span class="kd">function</span> <span class="nx">miseAJour</span><span class="p">()</span> <span class="p">{</span>
</span>  <span class="k">try</span> <span class="p">{</span>
<span class="hll">    <span class="kr">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">getJson</span><span class="p">(</span><span class="s2">&quot;https://monserveur/data.json&quot;</span><span class="p">);</span>
</span>    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;nom&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">nom</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;prenom&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">prenom</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">miseAJour</span><span class="p">();</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Une fonction asynchrone peut elle-même retourner une valeur. Dans ce cas,
la valeur retournée est une promesse. Si ce n’est pas le cas, alors une
promesse est créée puis résolue avec la valeur initialement retournée.</p>
<p>Ainsi :</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mf">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>est équivalent à</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ordre-des-appels-dans-un-traitement-asynchrone">
<h2>Ordre des appels dans un traitement asynchrone<a class="headerlink" href="#ordre-des-appels-dans-un-traitement-asynchrone" title="Lien permanent vers ce titre">¶</a></h2>
<p>La simplicité de lecture offerte par l’introduction des mots-clés <code class="docutils literal notranslate"><span class="pre">async</span></code> et
<code class="docutils literal notranslate"><span class="pre">await</span></code> est indéniablement importante. Cependant, il ne faut pas oublier que
les appels restent asynchrones et donc que l’ordre d’exécution n’est pas
nécessairement celui induit par la lecture du code. Pour nous en convaincre,
nous allons prendre un exemple simpliste. Imaginons que nous voulions coder
une méthode asynchrone pour réaliser l’addition de deux nombres… ce qui n’a
aucun intérêt à part de nous servir d’illustration.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">addition</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">resolve</span><span class="p">(</span><span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>La fonction <code class="docutils literal notranslate"><span class="pre">addition</span></code> retourne une promesse qui se résoudra par la somme des
paramètres.</p>
<p>Nous pouvons déclarer une fonction asynchrone qui appelle cette fonction avec
<code class="docutils literal notranslate"><span class="pre">await</span></code> et qui écrit le résultat de l’appel dans la console :</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">calculer</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">await</span> <span class="nx">addition</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span> <span class="mf">3</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Si nous appelons cette fonction :</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">calculer</span><span class="p">();</span>
</pre></div>
</div>
<p>La valeur <code class="docutils literal notranslate"><span class="pre">5</span></code> s’affiche dans la console. Mais que se passe-t-il si nous
modifions légèrement notre programme de la façon suivante :</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Avant l&#39;appel à calculer&quot;</span><span class="p">);</span>
<span class="nx">calculer</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Après l&#39;appel à calculer&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>En exécutant ce code, nous obtenons le résultat suivant dans la console :</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Avant l&#39;appel à calculer
Après l&#39;appel à calculer
5
</pre></div>
</div>
<p>Ce résultat peut être difficile à comprendre. On a l’impression que la fonction
<code class="docutils literal notranslate"><span class="pre">calculer</span></code> n’a pas été appelée au moment attendu. En fait, il faut se souvenir
que la fonction <code class="docutils literal notranslate"><span class="pre">calculer</span></code> est asynchrone et que le modèle d’exécution de
l’interpréteur JavaScript est limité à un flux de traitement (<em>mono threaded</em>).</p>
<p>Reprenons le programme : on commence par afficher le message « Avant l’appel à
calculer », puis on appelle la fonction <code class="docutils literal notranslate"><span class="pre">calculer</span></code>. Cette fonction est une
fonction asynchrone. Elle appelle la fonction <code class="docutils literal notranslate"><span class="pre">addition</span></code> avec le mot-clé
<code class="docutils literal notranslate"><span class="pre">await</span></code>. Cette dernière fonction retourne une promesse qui sera appelée de
manière asynchrone lorsque l’interpréteur JavaScript aura fini d’exécuter le
flux de traitement courant car il ne peut traiter qu’un flux à la fois. Le
traitement de la fonction <code class="docutils literal notranslate"><span class="pre">calculer</span></code> est donc suspendu et on passe à l’étape
suivante du programme qui consiste à afficher le message « Après l’appel à
calculer ». Comme le programme est maintenant terminé, le flux de traitement
est disponible pour exécuter la promesse. Cette dernière est résolue en
fournissant le résultat de l’addition et le traitement de la fonction <code class="docutils literal notranslate"><span class="pre">calculer</span></code>
peut enfin reprendre et afficher le résultat de l’addition.</p>
<p>On voit que, même si le programme nous semble écrit de manière séquentielle,
l’ordre d’exécution est bien différent. Il faut surtout se rappeler que pour
qu’une fonction asynchrone s’exécute, il faut que le traitement courant se
termine le plus vite possible pour permettre à l’interpréteur de passer au
traitement asynchrone.</p>
</div>
<div class="section" id="la-boucle-for-await">
<h2>La boucle for await<a class="headerlink" href="#la-boucle-for-await" title="Lien permanent vers ce titre">¶</a></h2>
<p>Il existe une variante de l’itération avec <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">await</span> <span class="pre">...</span> <span class="pre">of</span></code>. Il est ainsi
possible de parcourir des tableaux, des chaînes de caractères, des collections
de nœuds DOM… de manière asynchrone. Comme pour le mot-clé <code class="docutils literal notranslate"><span class="pre">await</span></code>, la
structure <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">await</span> <span class="pre">...</span> <span class="pre">of</span></code> ne peut être utilisée que dans une fonction asynchrone.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Exemple d’utilisation de for await</span><a class="headerlink" href="#id1" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">afficherNombre</span><span class="p">(...</span><span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="nx">await</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Si nous appelons deux fois de suite cette fonction :</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">afficherNombre</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span> <span class="mf">2</span><span class="p">,</span> <span class="mf">3</span><span class="p">,</span> <span class="mf">4</span><span class="p">,</span> <span class="mf">5</span><span class="p">,</span> <span class="mf">6</span><span class="p">,</span> <span class="mf">7</span><span class="p">,</span> <span class="mf">8</span><span class="p">,</span> <span class="mf">9</span><span class="p">,</span> <span class="mf">10</span><span class="p">);</span>
<span class="nx">afficherNombre</span><span class="p">(</span><span class="mf">101</span><span class="p">,</span> <span class="mf">102</span><span class="p">,</span> <span class="mf">103</span><span class="p">,</span> <span class="mf">104</span><span class="p">,</span> <span class="mf">105</span><span class="p">,</span> <span class="mf">106</span><span class="p">,</span> <span class="mf">107</span><span class="p">,</span> <span class="mf">108</span><span class="p">,</span> <span class="mf">109</span><span class="p">,</span> <span class="mf">110</span><span class="p">);</span>
</pre></div>
</div>
<p>Alors nous verrons bien le comportement asynchrone puisque l’affichage
entremêlera les traitements des deux tableaux de valeurs :</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Résultat du programme précédent</span><a class="headerlink" href="#id2" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>1
101
2
102
3
103
4
104
5
105
6
106
7
107
8
108
9
109
10
110
</pre></div>
</div>
</div>
<p>Si vous voulez créer votre propre itérable pour l’utiliser avec la structure
<code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">await</span> <span class="pre">...</span> <span class="pre">of</span></code>, alors cet objet doit fournir une méthode <code class="docutils literal notranslate"><span class="pre">&#64;&#64;asyncIterator</span></code>.
Cette méthode doit retourner un itérateur déclarant une méthode <code class="docutils literal notranslate"><span class="pre">next</span></code>.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">premiersNombres</span> <span class="o">=</span>  <span class="p">{</span>
  <span class="p">[</span><span class="nx">Symbol</span><span class="p">.</span><span class="nx">asyncIterator</span><span class="p">]()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">i</span><span class="o">:</span> <span class="mf">0</span><span class="p">,</span>
      <span class="nx">next</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mf">10</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">i</span><span class="o">++</span><span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span><span class="p">};</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">done</span><span class="o">:</span> <span class="kc">true</span><span class="p">};</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">afficherPremiersNombres</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="nx">await</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">premiersNombres</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>La structure <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">await</span> <span class="pre">...</span> <span class="pre">of</span></code> accepte également les générateurs. Cela permet
d’appeler de manière asynchrone une fonction générative :</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="o">*</span> <span class="nx">premiersNombres</span><span class="p">(</span><span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">max</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">yield</span> <span class="nx">i</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">afficherPremiersNombres</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="nx">await</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">premiersNombres</span><span class="p">(</span><span class="mf">10</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../threejs/introduction.html" class="btn btn-neutral float-right" title="Introduction et mise en place" accesskey="n" rel="next">Suivant <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="promesse.html" class="btn btn-neutral float-left" title="Les promesses" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Précédent</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
  <div  role="contentinfo">
    <p>
    Par David Gayerie
    - <script>!function(){function e(e){return e.replace(/[a-zA-Z]/g,function(e){return String.fromCharCode((e<="Z"?90:122)>=(e=e.charCodeAt(0)+13)?e:e-26)})}!function(e){document.write("<a href='mailto:"+e+"'>"+e+"</a>")}(e("qnivq@tnlrevr.qri"))}();</script>
    - <a class="reference external" href="https://gayerie.dev">https://gayerie.dev</a>
    </p>
    <p class="copyright">
      <a class="reference external image-reference" href="https://creativecommons.org/licenses/by-sa/3.0/fr/"><img alt="Licence Creative Commons" src="https://i.creativecommons.org/l/by-sa/3.0/fr/88x31.png" /></a>
      Cette œuvre est mise à disposition selon les termes de la <a class="reference external" href="https://creativecommons.org/licenses/by-sa/3.0/fr/">Licence Creative Commons Attribution</a> -  Partage dans les Mêmes Conditions 3.0 France
    </p>
  </div>


</footer>

        </div>

      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-99071053-2', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>